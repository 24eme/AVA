<?php

/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */

/**
 * Description of ParcellaireExploitationTypeProprietaireForm
 *
 * @author mathurin
 */
class ParcellaireExploitationTypeProprietaireForm extends acCouchdbObjectForm {

    public function configure() {
        $typesProprietaire = $this->getTypesProprietaire();
        $vendeurs = $this->getAllVendeurs();

        $this->setWidget('type_proprietaire', new sfWidgetFormChoice(array('multiple' => true, 'expanded' => true, 'choices' => $typesProprietaire)));
        $this->getWidget('type_proprietaire')->setLabel("type_proprietaire", "Type proprietaire:");
        $this->setValidator('type_proprietaire', new sfValidatorChoice(array('required' => true, 'choices' => array_keys($typesProprietaire)), array('required' => "Aucun type de propriétaire n'a été choisi.")));


        $this->setWidget('vendeurs_select', new sfWidgetFormChoice(array('choices' => $vendeurs)));
        $this->getWidget('vendeurs_select')->setLabel("vendeurs_select", "Choisir un vendeur:");
        $this->setValidator('vendeurs_select', new sfValidatorChoice(array('required' => true, 'choices' => array_keys($vendeurs)), array('required' => "Aucun type de propriétaire n'a été choisi.")));

        $this->widgetSchema->setNameFormat('parcellaire_type_proprietaire[%s]');
    }

    public function doUpdateObject($values) {
        parent::doUpdateObject($values);
    }

    public function getTypesProprietaire() {
        return ParcellaireClient::$type_proprietaire_libelles;
    }

    public function getAllVendeurs() {
        $types_vendeurs = array(CompteClient::ATTRIBUT_ETABLISSEMENT_NEGOCIANT,
            CompteClient::ATTRIBUT_ETABLISSEMENT_CAVE_COOPERATIVE);
        
        $query = "statut:ACTIF AND (";
        foreach ($types_vendeurs as $type_vendeurs) {
            $query .="infos.attributs.".$type_vendeurs.":\"".CompteClient::getInstance()->getAttributLibelle($type_vendeurs)."\" OR ";
           
        }
        $query = substr($query, 0, strlen($query) - 4).")";       
  
        $qs = new acElasticaQueryQueryString($query);
        $q = new acElasticaQuery();
        $q->setLimit(9999);
        $q->setQuery($qs);

        $index = acElasticaManager::getType('compte');
        
        $resset = $index->search($q);
        $results = $resset->getResults();

        $list = array();
        foreach ($results as $res) {
            $data = $res->getData();
            $list[$data['cvi']] = $data['nom_a_afficher'].' ( '.$data['cvi'].' )';
        }
        return $list;        
    }

}
