<?php

class TirageExploitationForm extends EtablissementForm
{
    protected $tirage = null;

    public function __construct(Tirage $object, $options = array(), $CSRFSecret = null) {
        $this->tirage = $object;
        parent::__construct($this->tirage->getEtablissementObject(), $options, $CSRFSecret);
    }
    
    public function configure() {
        parent::configure();
        
        $chais = array_merge(array('' => ''), $this->getChais());

        $this->setWidget('lieu_stockage_same', new sfWidgetFormInputCheckbox());
        $this->setValidator('lieu_stockage_same', new sfValidatorBoolean(array('required' => false)));


        $this->setWidget('lieu_stockage', new bsWidgetFormChoice(array('choices' => $chais)));
        $this->getWidgetSchema()->setLabel('lieu_stockage', "Lieu de stockage");
        $this->setValidator('lieu_stockage', new sfValidatorChoice(array('required' => false, 'choices' => array_keys($chais))));
    }
    
    public function save($con = null) {
        parent::save($con);
    }

    protected function updateDefaultsFromObject() {
        parent::updateDefaultsFromObject();
        $this->setDefault('lieu_stockage_same', ($this->tirage->lieu_stockage) ? true : null);
        $this->setDefault('lieu_stockage', $this->tirage->lieu_stockage);
    }

    public function doUpdateObject($values) {
        parent::doUpdateObject($values);
        if(!$values['lieu_stockage_same'] && $values['lieu_stockage']) {
            $this->tirage->lieu_stockage = $values['lieu_stockage'];
        } else {
            $this->tirage->lieu_stockage = null; 
        }
    }
    
    public function getChais() {
    	$chais = array();
    	foreach ($this->tirage->getEtablissementObject()->chais as $chai) {
    		$libelle = $chai->adresse.' '.$chai->code_postal.' '.$chai->commune;
    		$libelleEtablissement = $this->tirage->getEtablissementObject()->adresse.' '.$this->tirage->getEtablissementObject()->code_postal.' '.$this->tirage->getEtablissementObject()->commune;
    		if ($libelle == $libelleEtablissement) {
    			continue;
    		}
    		$chais[$libelle] = $libelle;
    	}
    	return $chais;
    }
}